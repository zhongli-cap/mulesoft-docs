= FTPS and EDI X12 Purchase Order Walkthrough
:keywords: b2b, ftps, edi x12 purchase, order, walkthrough, amazon, s3

=== Audience
This document is for a technical audience possessing basic knowledge of FTPS, X12, and Anypoint Platform. Familiarity of link:http://modusintegration.github.io/mule-connector-ftps/[FTPS Connector], link:/anypoint-b2b/x12-module[X12 Module] and link:/anypoint-studio/v/5/datamapper-user-guide-and-reference[Anypoint DataMapper User Guide and Reference] is assumed.

=== Prerequisites

* Anypoint Studio with Mule Server 3.7.x EE runtime
* FTPS Connector 1.x, Partner Manager Connector 2.x, and X12 Module 1.x installed
* Anypoint Platform account
* Amazon S3 bucket for FTPS and EDI file storage (optional)

=== Walkthrough Resources

* link:_attachments/ftps-x12-walkthrough.zip[ftps-x12-walkthrough.zip]
* link:_attachments/ftps-x12-po.xml[ftps-x12-po.xml]
* link:_attachments/ftps-x12-po.xsd[ftps-x12-po.xsd]

== Run the Example

To run this example, follow the steps below:

. Download the link:_attachments/ftps-x12-walkthrough.zip[ftps-x12-walkthrough.zip] application, and unzip.
. Import the application in Anypoint Studio: click *File* > *Import* > *Anypoint Studio Project from External Location*. Click *Next*, select the downloaded application, and click *Finish*.
. From your web browser, log into Anypoint Partner Manager (contact your MuleSoft account manager for access).
. Click the home organization view in the top right corner. Create your API key (reference step 3.2).
. In Anypoint Studio, click the file _customer.xml_ in the app directory, and select the Global view tab. Double-click the Partner Manager connector element configuration and insert the API key you created from Anypoint Partner Manager.
. Right-click on the imported project directory _FTPS-x12-walkthrough_. Select *Run As* and click *Mule Application*.
. Inside the project is a file in _src/test/resources_ called link:_attachments/FTPS-x12-po.xml[po.xml]. Create a copy and place it in the _outbox_ directory.
. The file should disappear from the directory since the File message source deletes the file once it reads it.
. Access the B2B Transmissions view in Anypoint Partner Manager to confirm that the FTPS and X12 transmissions have taken place.

== Introduction

This example shows how to leverage Anypoint Partner Manager to manage and track B2B processes. The goal is to develop a
Mule application, representing a customer, that transforms an XML purchase order read from the filesystem to an X12 850
and sends it to a supplier over FTPS. The supplier returns an X12 997 via a FTPS server the application is polling from
in order to inform the customer whether the 850 was accepted or rejected. Anypoint Partner Manager manages and records
all B2B exchanges while the actual files exchanged are stored on an Amazon S3 bucket.

== Partnership Set Up

The first stage of the solution is to create a partnership in Anypoint Partner Manager between your organization and the
supplier.

A partnership:

* Identifies of your Company
* Identifies your partner
* Establishes the parameters by which B2B data is exchanged between you and your partner
* Allows this data to be tracked and viewed from Anypoint Partner Manager

=== Set Up Home Organization Identifiers

. Login into Anypoint Partner Manager.
. On the left menu, click *Trading Partners*.
. Click on the top partner in the list, "Your company".
. On the left menu, click *X12* under *FORMAT DEFAULTS*.
. Enter _MOUNTAINOUT_ as *Interchange ID (ISA)*, Select *ZZ (Mutually Defined)* from the *Interchange ID qualifier (ISA)* and press *Save*.

=== Set Up FTPS
. On the left menu, click *Endpoints* under *CONFIGURATION*.
. In the top right, Click New.
. In the *Endpoint* section, fill in the fields as shown in the table below:
+
[%autowidth.spread]
|===
|*Field* |*Value*
|Name |FTPS Send
|Protocol |FTPS
|Type |Send
|Default |TRUE
|===
+
. Make sure Default for My Supplier is checked
. Enter the following values in the *Settings* sections:
.. In the *Server Address* field, enter the address for the server you want to use.
.. In the *Port* field, enter the number of the port for your server (typically 21).
.. In the *User Name* field, enter the username for the account you created on the FTPS cloud service you procured in Step a.
.. In the *Password* field, enter the password for the account you created on the FTPS cloud service you procured in Step a.
.. _Passive_ in the *Transfer Mode* field
.. _Explicit_ in the *SSL Mode* field
. Leave checkbox, *Enable server validation field* unchecked.
. Press *Save*.
. In the top right, Click New.
. In the *Endpoint* section, fill in the fields as shown in the table below:
+
[%autowidth.spread]
|===
|*Field* |*Value*
|Name |FTPS Receive
|Protocol |FTPS
|Type |Receive
|Default |TRUE
|===
+
. Reuse your *FTPS Send* fields values to fill in the *Settings* section for *FTPS Receive*.
.. In the *Server Address* field, enter the address for the server you want to use.
.. In the *Port* field, enter the number of the port for your server (typically 21).
.. In the *User Name* field, enter the username for the account you created on the FTPS cloud service you procured in Step a.
.. In the *Password* field, enter the password for the account you created on the FTPS cloud service you procured in Step a.
.. _Passive_ in the *Transfer Mode* field
.. _Explicit_ in the *SSL Mode* field
.. Leave checkbox, *Enable server validation field* unchecked.
.. In the *Path* field, enter the path you want to use in your server.
.. Leave *Mover to Directory*, *Polling frequency* and *Maximum Number of Download Threads* with there default values.

. Click Save, then press *Endpoints* with the back arrow on the left menu.

=== Set Up X12

. On the left menu, click *X12* under *FORMAT DEFAULTS*.
. Enter _My Supplier_ as *Interchange ID (ISA)*, Select *ZZ (Mutually Defined)* from the *Interchange ID qualifier (ISA)*.
. In the *Inbound* section, fill in the fields as shown in the table below: 
+
[%autowidth.spread]
|===
|*Field* |*Value*
|Interchange sender ID qualifier  (ISA 05) |ZZ
|Interchange sender ID (ISA 06) |MY-SUPPLIER
|Require unique GS control numbers (GS 06) |FALSE
|===
+
. In the *Outbound* section, fill in the fields as shown in the table below:
+
[%autowidth.spread]
|===
|*Field* |*Value*
|Interchange receiver ID qualifier (ISA 07) |ZZ
|Interchange receiver ID (ISA 08) |MY-SUPPLIER
|Repetition separator character (ISA 11) |U
|Default Interchange usage indicator (ISA 15) |Test
|Component element separator character (ISA 16) |>
|Segment terminator character |~
|Data Element Delimiter |*
|Character set |Extended
|Character encoding |ASCII
|Line ending between segments |LFCR
|Require unique GS control numbers (GS 06) |TRUE
|===
+
. Press *Save*.

== Mule Project Set Up

The next stage of the solution is to develop a Mule application that transforms an XML purchase order read from the filesystem to an X12 850 and sends it to the supplier over FTPS. The supplier returns an X12 997 to an FTPS endpoint the application is listening on in order to inform the customer whether the 850 was accepted or rejected. The application is split into two parts:

* A customer part that sends an 850 and receives a 997.

* A mock supplier that permits us to test the application without any external dependencies.

Each part has its own Mule configuration file.

* Launch Anypoint Studio and create a new Mule project.
* Rename the initial Mule configuration file created by Studio to _customer.xml_.
* Create a new Mule configuration file and name it _mock-supplier_.
+
image:b2b_ftps_walk_06.png[b2b_ftps_06]

== Customer Connector Configs

In this section, go through the next steps to create the customer's connector configs in the customer Mule config file before proceeding to build the customer flows.

=== Create Partner Manager Connector Config

The Partner Manager Connector acts like a bridge between Mule and Anypoint Partner Manager. It enables the management of FTPS
Connector and the X12 module in addition to the recording of B2B exchanges.

. Click the *Global Elements* view. Go to *Create* > *Connector Configuration* > *B2B: Basic Configuration*. If you
have an Amazon S3 bucket available, you should go instead to *Create*  > *Connector Configuration* >
*B2B: Amazon S3 File Storage*. The latter configuration type allows the Partner Manager Connector to persist X12 documents
and FTPS message content to Amazon S3.
. Enter your secret API key which is obtained from your home organization’s *Company* settings page in Anypoint Partner
Manager:
+
image:B2B_AS2EDI_13.png[B2B_AS2EDI_13]
+
The home organization settings are accessed by clicking on the home Trading Partners in the left menu, then clicking on the organization Partner:
+
image:B2B_AS2EDI_11.png[B2B_AS2EDI_11]
+
On the left menu, click *Administration* under *PARTNERS*. Here is the list of Environment, make sure to select the one you have created the Partner in. Click *Create a new API key* to generate a new API Key.
+
image:B2B_AS2EDI_12.png[B2B_AS2EDI_12]
+
. Press *OK*.

=== Create FTPS Connector Configs

. Remain in the *Global Elements* view to create a FTPS Connector config by going to *Create* >
*Connector Configuration* > *FTPS: Partner Manager Configuration*. Name it _b2b-based-ftps_.
. Enter _My Supplier_ as *Partner Name*.
. Select _X12_ from the *Standard* drop-down list.


=== Create X12 Module Config

. In the *Global Elements* view, goto *Create* > *Connector Configuration* > *X12 EDI* to create an X12 Module config.
. Enable *Use B2B Provider* to allow Anypoint Partner Manager to manage and track X12 exchanges.
. Check the *Create Object Manually* radio button and open the *Object Builder* to enter the schema path _/x12/005010/850.esl_ in the first entry list.
+
image:B2B_AS2EDI_14.png[B2B_AS2EDI_14]
+
. Set the interchange identifier attributes so that they correspond with the interchange identifiers you configured in Anypoint Partner Manager:
+
Self-identification:
+
[source,code,linenums]
----
Interchange sender/receiver ID qualifier = ZZ
Interchange sender/receiver ID = MOUNTAINOUT
Application sender/receiver code = MOUNTAINOUT
----
+
Partner identification:
+
[source,code,linenums]
----
Interchange sender/receiver ID qualifier = ZZ
Interchange sender/receiver ID = MY-SUPPLIER
Application sender/receiver code = MY-SUPPLIER
----
+
The interchange identifiers serve as the lookup key for finding the partnership to use for X12 processing.

The following screenshot should match what you have in the *Global Elements* view:
+
image:b2b_ftps_walk_12.png[b2b_ftps_12]

== Transform and Send 850 over FTPS

With the connector configs out of the way, construct a flow to read an XML purchase order from the filesystem, transform it to a canonical EDI message structure, and finally, write it out as an X12 850 document to send it out to your supplier over FTPS.

. Remain in the customer Mule config but change to the *Message Flow* view.
. Drag a *File* message source to the canvas to create a flow. Set the *Path* attribute to _outbox_.
. Add a *DataMapper* next to the *File* message source.
. Put an *X12 EDI* processor after the DataMapper. Set the *Connector Configuration* to the X12 config that you created in the previous section and select *Write* for the *Operation*.
. Go back to the DataMapper. Select for input type *XML* and use the schema _po.xsd_ to derive the structure to be mapped. Click the *Create mapping* button. You can link:_attachments/ftps-x12-po.xsd[download a copy of ftps-x12-po.xsd] and rename it to be po.xsd.
. Perform the mapping from XML to X12 850 as follows:
+
[%autowidth.spread]
|===========
|*Source: XML* |*Target: X12 850*
|PurchaserOrderNumber |BEG03 - Purchase Order Number
|'00' |BEG01 - Transaction Set Purpose Code
|'NE' |BEG02 - Purchase Order Type Code
|OrderDate |BEG05 - Date
|Quantity |PO102 - Quantity
|USPrice |PO104 - Unit Price
|PartNumber |PO107 - Produce/Service ID
|TotalPrice |Summary -> 100_CTT -> 0200_AMT -> AMT02 - Monetary Amount
|'TT' |Summary -> 100_CTT -> 0200_AMT -> AMT01 - Amount Qualifier Code
|===========
+
. The last message processor in the flow is an FTPS processor that sends the 850. Set the *operation* to *Write* and leave the other fields as they are.
+
Note that these identifiers were set in Anypoint Partner Manager. The Partner Name set in the FTPS configuration serve as lookup key for finding
the partnership to use for transmitting the message.
+
image:b2b_ftps_walk_15.png[b2b_ftps_15]

== Receive 997 over FTPS

The subsequent flow to develop will receive a 997 over FTPS from the supplier in response to the 850 sent by you. In the
_customer.xml_ Mule config:

. Drag the FTPS processor to the canvas so as to create a message source for a new flow.
+
. Drag a *Byte Array to String* transformer next to the FTPS source.
. Add an *X12* processor next to the message source and select the *Read* operation. Point the *Connector Configuration* to the X12 Module config that you created in the previous section
+
image:b2b_ftps_walk_18.png[b2b_ftps_18]

== Develop Mock Supplier

The mock supplier receives the 850 and generates a 997 to send back to the customer over FTPS:

. Open the _mock-supplier.xml_ Mule config.
. Similar to what you did for the customer, create a pair of FTPS Connector configs and
an X12 Module config. Ensure that:
+
* *Use B2B Provider* remains disabled for all EDI configs.
* Basic FTPS Connector config is created: *Create* -> *Connector Configuration* -> *FTPS: Basic Configuration*.
* Same FTPS settings as APM are entered; also click on the *Advanced* tab and check _Disable certificate validation_.
* Click *Test Connection...* and make sure the connection could be established.
* X12 Module config schema path is set to _/x12/005010/850.esl_.
* Unique names are given to the configs.
+
. Drag a _FTPS Connector_ to the flow.
. Select the _FTPS Basic Configuration_ created above as *Connector Configuration* and select *Read* as operation.
. Enter _/demo/supplier-inbox/_ as *Path* and _*.dat_ in *Filename*. The polling setting should be set to 15000 (_this is due to a limitation on the hostedftp server_)
+
image:b2b_ftps_walk_20.png[b2b_ftps_20]
+
. Add a *ByteArray to String* transformer.
. Add an *X12* processor to the flow. Select the mock supplier s X12 config for *Connector Configuration* and set  its *Operation* to *Read*.
. After the 850 is parsed by the X12 processor, the generated 997 needs to be extracted from the payload. Add the
*Set Payload* processor to the processor chain and enter in its *Value* attribute: _#[ ['TransactionSets' : [ 'v005010' : [ '997' : payload.FunctionalAcksGenerated ] ] ] ]_.
. Add another *X12* processor to serialize the 997. Select the mock supplier's X12 config for *Connector Configuration*. Expand the *Operation* drop-down list and select *Write*.
+
. The last step in the flow to send the 997 over FTPS. Append a FTPS processor to the flow; select the same local FTPS global configuration for the FTPS message source of point 4, select the *Write* operation.
. Enter _/demo/consumer-inbox/_ in *Path*.
+
image:b2b_ftps_walk_22.png[b2b_ftps_22]

== Run Application

. Run the application as a *Mule Application*. On startup, the application creates the _outbox_ directory in the project's root directory. If the _outbox_ directory isn't visible, try refreshing the project in the *Package Explorer* view.

. Drop the purchase order file link:_attachments/ftps-x12-po.xml[ftps-x12-po.xml], included with this document, in the _outbox_ directory. The file should disappear from the directory since the *File* inbound endpoint deletes the file after it reads it.
. Access the B2B Transmissions view in Anypoint Partner Manager to confirm that the FTPS and X12 transmissions have taken place.
+
