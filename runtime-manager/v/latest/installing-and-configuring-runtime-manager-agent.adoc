= Installing the Runtime Manager Agent
:keywords: agent, runtime manager, mule, esb, servers, monitor, notifications, external systems, third party, get status, metrics

_Enterprise Edition_

image:logo-cloud-disabled.png[link="/runtime-manager/deployment-strategies", title="CloudHub"]
image:logo-hybrid-active.png[link="/runtime-manager/deployment-strategies", title="Hybrid Deployment"]
image:logo-server-active.png[link="/runtime-manager/deployment-strategies", title="Anypoint Platform On-Premises"]
image:logo-pcf-disabled.png[link="/runtime-manager/deployment-strategies", title="Pivotal Cloud Foundry"]

This document covers how to <<Installing the Agent from the Zip File, install>> or <<Updating a Previous Installation, update>> the Runtime Manager Agent, which mediates the communication between a Mule Runtime and the Runtime Manager. 

The Runtime Manager Agent is installed into a Mule runtime, and is used to register the Mule runtime with Runtime Manager. The Mule runtime is then registered and controlled by Runtime Manager within a specific environment of a specific Anypoint Platform business group.


The latest version of the Mule runtime usually comes bundled with the latest version of the Runtime Manager Agent. You can download the latest Mule runtime from the link:https://www.mulesoft.com/support-login[Customer Portal].

If you use an older version of the Mule runtime, or an older API Gateway Runtime, or if a newer version of the Runtime Manager Agent releases in between Mule runtime releases, then you can download and install the latest version of the Runtime Manager Agent from the
link:/release-notes/runtime-manager-agent-release-notes[Runtime Manager Agent release notes]. 
s
[IMPORTANT]dddd
Mule 3.7.x and API Gateway 2.x provide an link:/runtime-manager/runtime-manager-agent[older version of the Runtime Manager Agent]. This version doesn't provide support for link:/runtime-manager/sending-data-from-arm-to-external-monitoring-software[Sending Data from Runtime Manager to External Monitoring Software]s
====


////d
[INFO]
If you're deploying your applications to a [Pivotal Cloud Foundry] environment, then you don't need to worry about installing or configuring the Runtime Manager Agent. In that scenario, the agent functions as usual as the link between the Mule runtimes and the Runtime Manager. However, the same PCF buildPack that automatically creates new runtime instances also creates agent instances and registers these to the Runtime Manager. If you want to change the configuration of your agent instances, you must modify the buildPack.
////

== Prerequisites

The Runtime Manager Agent continues to be available with the Mule and API Gateway software distributions; however, you should use the new zip version to update your Runtime Manager Agent to the latest version.

This document assumes that your enterprise license is current. See link:/mule-user-guide/v/3.8/installing-an-enterprise-license[Installing an Enterprise License] for information on obtaining and installing an enterprise license.

The Runtime Manager Agent works with Mule 3.6.0 and newer, and API Gateway 2.1 and newer.

[TIP]
We recommend that you run the latest version of Mule Enterprise. You can download the latest version from the link:http://www.mulesoft.com/support-login[customer portal].


== Installing from a Software Distribution

The agent comes bundled with your Mule runtime installation. You can install it by running `$MULE_HOME/bin/amc_setup` (or `$MULE_HOME\bin\amc_setup.bat` if on Windows).

*See the <<Installation Options>> section below for a the arguments that can be used when running this command.*

[IMPORTANT]
====
Currently, Mule 3.7.x and older, and API Gateway 2.x and older provide an link:/release-notes/runtime-manager-agent-release-notes[older version of the Runtime Manager Agent]. This version doesn't provide support for link:/runtime-manager/sending-data-from-arm-to-external-monitoring-software[Sending Data from Runtime Manager to External Monitoring Software]. Newer versions that do provide support for this must be downloaded separately.

*Mule 3.6.0 and 3.6.1 Installation:*

Download the agent and follow the steps in the <<Installing the Agent from the Zip File,Installing the Agent from the Zip File>> section. Then run `amc_setup` or `amc_setup.bat` depending on your OS.
====

== Download the Latest Version of the Agent


Download the link: http://mule-agent.s3.amazonaws.com/1.5.1/agent-setup-1.5.1.zip[Runtime Manager Agent zip file].

Note that the latest version of the Mule runtime comes already bundled with this version of the Runtime Manager Agent.

You can also find the download links to older versions of the Runtime Manager in the link:/release-notes/runtime-manager-agent-release-notes[release notes page]

== Installing the Agent from the Zip File
. Stop Mule or the API Gateway runtime. You can stop Mule with the `./bin stop` command or by killing the process.
. Expand the `mule-agent-[VERSION].zip` file to the `$MULE_HOME/bin` Mule software distribution folder.
. When prompted, replace (overwrite) any conflicting files (`amc_setup` and `amc_setup.bat`). 
+
[TIP]
====
The agent zip file contains these 3 files.

* `amc_setup` - Mac and Linux installation file
* `amc_setup.bat` - Windows installation file
* `agent-setup-<version>.jar` - Called by the installation files
====
+
. Depending on your OS, run `amc_setup` or `amc_setup.bat` on the command line to install or update the Runtime Manager Agent plugin.


*See the <<Installation Options>> section below for a the arguments that can be used when running this command.*

The installed Runtime Manager Agent works correctly with Mule and API Gateway runtimes versions that already include the Runtime Manager Agent in the distribution.




== Updating a Previous Installation

After downloading the Runtime Manager Agent zip file, determine if you can simply update an existing Runtime Manager Agent installation. Check on the corresponding link:/release-notes/runtime-manager-agent-release-notes[release notes]. 

This section shows you how to update a previous Runtime Manager Agent installation. Otherwise, skip down to [Installation Options](#installation-options) to see how to install a new Runtime Manager Agent for the first time. 

[TIP]
If you're not sure if a prior version has already been installed, check the `$MULE_HOME/conf` folder. If a previous version was installed, then there should be a `mule_agent.yml` configuration file in that folder.

Previous releases of compatible Mule and API Gateway runtimes shipped with an older version of the `amc_setup` script. If you already ran an older version of this script to install an earlier version of the Runtime Manager Agent, then follow these steps to keep your existing Runtime Manager Agent configuration and modifications:


. Run `./amc_setup -U` to update the agent version. If you are using Windows, run: `amc_setup.bat -U`.
+
[TIP]
*See the <<Installation Options>> section below for a the arguments that can be used when running this command.*

. Restart Mule with the `$MULE_HOME/bin/./mule restart` command.

[NOTE]
For information on starting and stopping API Gateway, see link:/api-manager/configuring-an-api-gateway[Configuring an API Gateway].


=== About the Runtime Manager Agent Update Process

The amc_setup script makes the following changes to your Mule runtime installation:

. Backs up the current version of the agent:
** Everything under `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER` is archived into  `$MULE_HOME/tools/mule-agent-backup.zip`.
** Any custom modules you have installed (usually located in `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib/modules`) are archived into  `$MULE_HOME/tools/mule-agent-modules-backup.zip`.
. Updates agent libs under `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib`
. Keeps the current `$MULE_HOME/conf/mule-agent.yml` configuration file.
. Keeps modules under `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib/modules` unchanged (all custom modules added to the agent that are not included in the agent distribution should be installed in this folder).
. No reregistration is needed after the process is done, just restart the Mule or API Gateway instance.


== Installation Options

If you are not updating a previous Runtime Manager Agent installation, or if you want to change some of the configuration options, then you may need to run the `amc_setup` command with other options.

There are three different ways to install and configure a Runtime Manager Agent. 

. Connect a Runtime Manager Agent with a Anypoint Platform Runtime Manager cloud-based console.
. Connect a Runtime Manager Agent with an Anypoint Platform On-Premises Edition Runtime Manager console. 
. Connect a Runtime Manager Agent with a 3rd party monitoring console. 
 
Each configuration choice has a different set of options for the `amc_setup` command. 

You can run `./amc_setup --help` to see the available options for the installation command. 

Most of the Runtime Manager Agent configuration options add configuration text to the `$MULE_HOME/conf/mule-agent.yml` file. Often you can combine several configuration options into a single `amc_setup` command, or you can add additional configurations later by re-running the `amc_setup` command with different (non-conflicting) options. For example, you can configure a Runtime Manager Agent to communicate with both a Runtime Manager server and with a 3rd party console. 

Normally, you will configure a Runtime Manager Agent to communicate and exchange monitoring information with an Anypoint Platform Runtime Manager cloud console. This type of installation is performed using the `-H` option, using the security token provided by the Anypoint Platform Runtime Manager cloud console. Communication with either type of Anypoint Runtime Manager console is via websockets, and will be configured as a WebSockets transport in the `$MULE_HOME/conf/mule-agent.yml` file. 

You can also configure a Runtime Manager Agent to communicate with other management consoles via one or more REST transports. These configuration options can be used in addition to the `-H` option. Each set of configuration options adds configuration sections to the `$MULE_HOME/conf/mule-agent.yml` file. In addition to using the `amc_setup` command, you can also backup various configuration options and manually edit the `$MULE_HOME/conf/mule-agent.yml`. Also, there are other configuration options that are not possible using the `amc_setup` command, such as extending JMX monitoring to other external services. MuleSoft provides several OpenSource JMX monitoring publishing modules for Cloudwatch, Graphite, Nagios, and Zabbix. The Nagios module is already included in Mule runtime. 
Cloudwatch publishers: allows users to send JMX metrics to Amazon Cloudwatch.

Graphite: provides Graphite JMX metrics integration.

Nagios: provides integration with Nagios.

Zabbix: module to send metrics to Zabbix instances.

For further information please check the JMX section in Mule Agent documentation.
  

=== Installing a Mule runtime into an Anypoint Platform Runtime Manager cloud console
The simplest way to install a new Runtime Manager Agent is to use the `-H` option. 

In the Runtime Manager console, you can see a full example of the code you need to run by clicking the link:/runtime-manager/managing-servers#add-a-server[Add a Server] button. This example command already includes your specific organization's ID, so it's ready to use in case you don't need to configure anything beyond the default settings.


Below is a table with the different arguments you can add to the `amc_setup` command. The required arguments differ depending on if you're registering your server to be managed via the cloud console of Runtime Manager, or to be managed by the Anypoint Platform On-Premises Edition (beta).

////
[tabs]
------
[tab,title="Cloud Console"]
....
////

[%header,cols="20a,80a"]
|===
|Parameter|Description

|`-H`
|Configures the Runtime Manager Agent to create a hybrid management connection with a Runtime Manager. This option requires a token (provided by the Runtime Manager Console) and a name for the Mule server as you want it to appear in the Runtime Manager. For example:

[source,Console]
----
-H <token> myserver
----

To obtain the token, you need to use the *Add Server* option in the Runtime Manager. Once you have the token, copy-paste it as the `-H` parameter for your agent installation command.


[WARNING]
It is not supported to register a Mule runtime with both an older link:/mule-management-console/[Mule Management Console (MMC)] and a link:/runtime-manager/deployment-strategies[CloudHub]. If the Mule runtime is currently managed in MMC, you should first unregister the Mule runtime with MMC before running the `amc_setup -H` script.

For details, see link:/runtime-manager/managing-servers#add-a-server[Managing Servers].


|`-I`
|Configures the Runtime Manager Agent to use an unencrypted connection. It is valid for the REST transport only. You can interact with the API using a browser or other tool for making HTTP requests.

|`-S`
|Configures the Runtime Manager Agent to establish a TLS connection with an on-premises administration console. You need to provide the truststore and keystore in JKS format. This option enables a TLS channel for REST communications only. See <<Secure Connection Channel>>. Note that this is for manually managing the Agent (i.e. not using ARM cloud-console to manage the Agent)

|`-P`
`--proxy`
|When configuring Runtime Manager Agent to connector the Runtime Manager via a proxy, this option defines proxy details. See <<Installation Via Proxy>>.

|`--mule-home`
|Your `$MULE_HOME` directory. Use this option if you are not running the installation script from `$MULE_HOME/bin`.

|`-U`
|Update the Runtime Manager Agent software.

|===



....
[tab,title="Anypoint Platform On-Premises Edition"]
....

[%header,cols="20a,80a"]
|===
|Parameter|Description
|`-H`
|Configures the Runtime Manager Agent to create a hybrid management connection with a Runtime Manager. This option requires a token (provided by the Runtime Manager Console) and a name for the Mule server as you want it to appear in the Runtime Manager. For example:

[source,Console]
----
-H <token> myserver
----

To obtain the token, you need to use the *Add Server* option in the Runtime Manager. Once you have the token, copy-paste it as the `-H` parameter for your agent installation command.


[WARNING]
It is not supported to register a Mule runtime with both an older link:/mule-management-console/[Mule Management Console (MMC)] and a link:/runtime-manager/deployment-strategies[CloudHub]. If the Mule runtime is currently managed in MMC, you should first unregister the Mule runtime with MMC before running the `amc_setup -H` script.

For details, see link:/runtime-manager/managing-servers#add-a-server[Managing Servers].

|`-A`
| IP Address of your local instance of Runtime Manager. It should follow the format `IP:port/hybrid/v1`
|`-W`
| IP Address of your local instance of MCM. It should follow the format `IP:port/mule`
|`-C`
| Address of your local instance of Access Management. It should follow the format `IP/accounts`
|`-F`
| Access of your local instance of API Manager. It should follow the format `IP/apiplatform`
|===

Full sample command:

[code, bash, linenums]
----
./amc_setup -H <token> <server name> -A http://$DOCKER_IP_ADDRESS:8080/hybrid/api/v1 -W "wss://<Anypoint Platform host>:8443/mule" -C https://<AnypointPlatform host>/accounts -F https://<Anypoint Platform host>/apiplatform
----


....
------



=== Hybrid Management

This option, configurable on the installation command through the '-H' argument, configures the Runtime Manager Agent to connect to the Runtime Manager. This option requires a token (provided by the Runtime Manager console) and an instance name. For details, see link:/runtime-manager/managing-servers#add-a-server[Managing Servers].

=== Insecure Connection Channel

This option, configurable on the installation command through the '-I' argument, configures the Runtime Manager Agent to use an unencrypted connection. It is valid for the REST transport only. You can interact with the API using a browser or other tool for making HTTP requests.

=== Secure Connection Channel

This option, configurable on the installation command through the '-S' argument, configures the Runtime Manager Agent to establish a TLS connection with an on-premises administration console.

[source, code]
----
Anypoint Runtime Manager Agent Installer ----------- Mode [Secure connection Channel(S) / Insecure Connection Channel(I) / Quit(Q)] (?):
----

You need to provide the truststore and keystore in JKS format. This option enables a TLS channel for REST communications only. Once you select the Secure connection Channel mode, you see the following menu:

[source,yaml, linenums]
----
The communication channel for the agent will be encrypted using
public/private key certificates. In the following steps you
will be asked to provide the keystore and truststore.
Both keystore and truststore format must be JKS.

Keystore location (?):
Truststore location (?):
Keystore Password (?):
Keystore Alias (?):
Keystore Alias Password (?):
INFO: Mule agent was successfully configured to use a TLS channel for REST communications.
----
_Keystore location_

The location of the keystore file to encrypt the communication channel. The keystore must be in JKS format. It is mandatory to provide one.

_Truststore location_

The location where of the truststore file to accept incoming requests from the administration console. The truststore must be in JKS format and must not have a password.

_Keystore Password_

The password to read the keystore. The password is used by the agent to open the keystore.

_Keystore Alias_

The alias of the key stored in the keystore.

_Keystore Alias Password_

The alias password in the keystore.



=== Installation Via Proxy

This option, configurable on the installation command through the '-P' argument, configures the Runtime Manager Agent to connect to the Runtime Manager via a proxy. User and password are optional and may be omitted if the proxy doesn't require authentication.

Where:

* _Proxy Host_ - The host of the desired proxy.
* _Proxy Port_ - The port of the desired proxy.
* _Proxy User_ - The user with which to authenticate against the proxy.
* _Proxy Password_ - The password with which to authenticate against the proxy.

If you have already installed the Runtime Manager Agent and want to change its configuration to use a proxy, you can do so by editing the `wrapper.conf` file. For details, see <<Setting up a Proxy>>.


== Configuring the Agent

The sections that follow provide additional configuration details for Runtime Manager Agent.

[NOTE]
If you wish to use the Agent to send data from the Runtime Manager to Splunk, an ELK stack or other external software, then you must configure it in a different way from the one described below. See link:/runtime-manager/sending-data-from-arm-to-external-monitoring-software[Sending Data from the Runtime Manager to External Monitoring Software] for details.


=== Configuring mule-agent.yml

At startup, the Runtime Manager Agent reads its configuration from the file `$MULE_HOME/conf/mule-agent.yml`. You must manually add, then edit this file with your installation's configuration parameters.

[source,yaml, linenums]
----
muleInstanceUniqueId: validId
organizationId: organizationId

transports:
    rest.agent.transport:
        security:
            keyStorePassword: mykeystorePassword
            keyStoreAlias: agent
            keyStoreAliasPassword: agentpassword
        port: 9997

services:
    mule.agent.application.service:
        enabled: true

    mule.agent.domain.service:
        enabled: true

    mule.agent.jmx.publisher.service:
        enabled: true
        frequency: 15
        frequencyTimeUnit: MINUTES
        beans:
            -   beanQueryPattern: java.lang:type=Runtime
                attribute: Uptime
                monitorMessage: Monitoring memory up-time
            -   beanQueryPattern: java.lang:type=MemoryPool,*
                attribute: Usage.used
                monitorMessage" : Used Memory

internalHandlers:
    domaindeploymentnotification.internal.message.handler:
        enabled: false

    applicationdeploymentnotification.internal.message.handler:
        enabled: false
----

==== Configuration File Structure

The `mule-agent.yml` file is structured in three levels:

* First level: Component types: transports, services, internalHandlers, and externalHanders.
** Second level: Component name, for example, `mule.agent.jmx.publisher.service`.
*** Third level: Component configuration. A component can have complex object configurations, including more than one recursive level.

To learn more on how to configure the Runtime Manager Agent, refer to the documentation of each component.

==== Configuring During Runtime

Some agent components allow you to configure them during runtime. For further information, see link:/runtime-manager/administration-service[Administration Service].

== Enabling REST Agent Transport and Websocket Transport

When you register the API Gateway in the Runtime Manager, the generated `mule-agent.yml` disables the REST agent Transport.

Conversely, if you run `./amc_setup -I`, you enable the REST agent Transport and disable the WebSocket Transport, that is the one used to connect to AMC.

To run both transports, modify the `mule-agent.yml` file as follows:

[source,yaml, linenums]
----
transports:
  websocket.transport:
    consoleUri: wss://mule-manager.anypoint.mulesoft.com:443/mule
    security:
      keyStorePassword: <password>
      keyStoreAlias: agent
      keyStoreAliasPassword: <password>
      handshake:
        enabled: true
        body:
          agentVersion: 1.1.0
          muleVersion: 3.7.0
          gatewayVersion: 2.0.2
  rest.agent.transport:
    port: 8888

services:
  mule.agent.jmx.publisher.service:
    enabled: true
    frequency: 15
    frequencyTimeUnit: MINUTES
----

== Ports and IPs to Whitelist


If you need to whitelist the ports or IPs for the communication between the Runtime Manager Agent and the Runtime Manager console please add the ones in the table below:

*Ports*

[%header,cols="2*a"]
|===
|Name |Port
|*anypoint.mulesoft.com* | 443
|*mule-manager.anypoint.mulesoft.com* | 443
|*analytics-ingest.anypoint.mulesoft.com* |  443
|*arm-auth-proxy.prod.cloudhub.io* |  443
|===

*IPs*

[%header,cols="2*a"]
|===
|Name |IP Address
|*mule-manager.anypoint.mulesoft.com* |52.201.174.72
|*mule-manager.anypoint.mulesoft.com* |52.201.67.218
|===

== Setting up a Proxy

You can configure the Runtime Manager Agent to send websocket messages through an HTTP proxy.

By default, the Runtime Manager Agent reads its proxy configuration from the same file that Anypoint API Gateway uses for its proxy configuration. This file is `wrapper.conf`, located under Mule's `conf/` directory. However, you can override the values stored in this file with values specific to the Runtime Manager Agent, by editing the agent's configuration file.

=== Default wrapper.conf File

`$MULE_HOME/conf/wrapper.conf`.

In this file the properties that define proxy configuration are:

* `anypoint.platform.proxy_host`
* `anypoint.platform.proxy_port`
* `anypoint.platform.proxy_username`
* `anypoint.platform.proxy_password`

=== Agent-specific mule-agent.yml File

`$MULE_HOME/conf/mule-agent.yml`.

To define proxy configuration specific to the Runtime Manager Agent, edit the configuration properties in this file as shown below. The properties in this file override those stored in the default `wrapper.conf` file.

[source, yaml, linenums]
----
globalConfiguration:
  proxyConfiguration:
    host: "http://exampleHost"
    port: 9999
    user: "exampleUser"
    password: "examplePassword"
----


== See Also

* link:/api-manager/configuring-an-api-gateway[Configuring an API Gateway]
* link:/runtime-manager/runtime-manager-agent-architecture[Runtime Manager Agent Architecture]
* link:/runtime-manager/event-tracking[Event Tracking]
