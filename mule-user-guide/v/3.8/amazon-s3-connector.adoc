= Amazon S3 Connector
:keywords: amazon, s3, connector, mule, integration, user guide
:imagesdir: ./_images

*Release Notes:* link:/release-notes/amazon-s3-connector-release-notes[Amazon S3 Connector Release Notes]

The Anypoint Amazon S3 Connector lets you interface with Amazon S3 to store objects, download and use data with other AWS services, and build apps that need internet storage. Amazon Simple Storage Service (Amazon S3) provides storage for the Internet. The AWS SDK for Java provides a Java API for AWS infrastructure services. For the complete list of operations supported by the connector, see link:http://mulesoft.github.io/s3-connector/[Versioned Reference Documentation and Samples].

MuleSoft maintains this connector under the link:/mule-user-guide/v/3.8/anypoint-connectors#connector-categories[_Select_] support policy.

== Prerequisites

To use the Amazon S3 connector, you must have the following:

* Access to Amazon Web Services. Log in and locate your access and secret key values to use in the settings that follow.
* Anypoint Studio Enterprise edition.
* An understanding of Mule, Anypoint Connectors, Anypoint Studio, Mule Flows, and Global Elements.

The Amazon S3 connector is compatible with Mule Runtime 3.8.0 and later, and AWS SDK for Java version 1.11.21.

Install instructions: link:/getting-started/anypoint-exchange#installing-a-connector-from-anypoint-exchange[Installing a Connector from Anypoint Exchange]

== To Configure a Global Element with the Visual Editor 

. In Anypoint Studio, click the Global Elements tab at the bottom of the Canvas.
. In the Choose Global Type window, expand Connector Configuration, and click Amazon S3: Configuration.
. Click OK.
. Enter information obtained from your AWS login for your Access Key and Secret Key.
. If needed, click Try Default AWS Credentials Provider Chain to indicate use of temporary credentials.
. If you are using Amazon S3 compatible storage instead of Amazon S3, specify its URL. If you need to connect to a different storage than the default AWS S3, you must specify its URL in the S3 Compatible Storage URL field. An example of S3 compatible storage is the link:https://github.com/minio[minio project]. For instance, if you configure it locally you may need to set the S3 Compatible Storage URL to `+http://127.0.0.1:9000+`
+
You can either enter your credentials into the global configuration properties, or reference a configuration file that contains these values. For simpler maintenance and better re-usability of your project, you can use a configuration file, which is useful to deploy to different environments, such as production, development, and QA, where your access credentials differ. See 
link:/mule-user-guide/v/3.8/deploying-to-multiple-environments[Deploying to Multiple Environments].
+
. Keep the Pooling Profile and the Reconnection tabs with their default entries. Or use the pooling profile to manage connector performance. For more information, see link:/mule-user-guide/v/3.8/tuning-performance[Tuning Performance].
. To encrypt the objects that you are going to store to S3 buckets using customer managed master keys, specify the Customer Master Key ID in the KMS Master Key field in the Create Object configuration.
. Click Test Connection to confirm that the parameters of your global configuration are accurate, and that Mule is able to successfully connect to your instance of Amazon S3. See: link:/anypoint-studio/v/6/testing-connections[Testing Connections].
. Specify an operation from the link:https://mulesoft.github.io/s3-connector[Connector Reference].

== To Configure a Global Element with the XML Editor

. Drag the connector from the palette onto the Anypoint Studio canvas to populate the XML code with the connector *namespace* and *schema location*.
+
*Namespace:* `+http://www.mulesoft.org/schema/mule/connector+` +
*Schema Location:* `+http://www.mulesoft.org/schema/mule/s3/current/mule-connector.xsd+`
+
. Paste these into the header of your *Configuration XML*, inside the `<mule>` tag.
+
[source, xml,linenums]
----
<mule xmlns:connector="http://www.mulesoft.org/schema/mule/connector"
  ...
  xsi:schemaLocation="http://www.mulesoft.org/schema/mule/connector http://www.mulesoft.org/schema/mule/connector/current/mule-connector.xsd">
  ...
  <flow name="yourFlow">
  ...
  </flow>
</mule>
----
+
. Include the Amazon S3 namespaces in your configuration file.
+
[source,xml, linenums]
----
<mule xmlns:s3="http://www.mulesoft.org/schema/mule/s3"  
  xmlns:http="http://www.mulesoft.org/schema/mule/http" 
  xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
  xmlns="http://www.mulesoft.org/schema/mule/core"  
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:spring="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans" 
  http://www.springframework.org/schema/beans/spring-beans-current.xsd
   <!-- Put your flows and configuration elements here -->
</mule>
----
+
. Create a global Amazon S3 configuration outside and above your flows, using the following global configuration code.
+
[source,xml, linenums]
----
<!-- simple configuration -->
<s3:config name="Amazon_S3_Configuration" accessKey="${s3.accessKey}" secretKey="${s3.secretKey}" 
doc:name="Amazon S3: Configuration"/>
----
+
. Enter information obtained from your AWS login for your accessKey and secretKey.
. If you are using Amazon S3 compatible storage instead of Amazon S3, specify its URL in the storageUrl field. An example of S3 compatible storage is the link:https://github.com/minio[minio project]. If you configure local storage, set storageUrl to the `+http://127.0.0.1:9000+` value.
. The connectionTimeout field defaults to 50000 milliseconds (50 seconds), maxConnections to 50, and socketTimeout to 50000 milliseconds.
. To encrypt the objects that you are going to store to S3 buckets using customer managed master keys, specify the Customer Master Key ID in the KMS Master Key field in the Create Object configuration.
. Specify an operation from the link:https://mulesoft.github.io/s3-connector[Connector Reference].

=== To Use AWS Credentials Provider Chain in Runtime Manager

With Default AWS Credentials Provider Chain you can specify the access key and secret in the Runtime Manager environment. 

. Use the following configuration to prepare a Mule app.
+
[source, xml]
----
 <s3:config name="Amazon_S3__Configuration" accessKey="dummy" secretKey="dummy" doc:name="Amazon S3: Configuration" tryDefaultAWSCredentialsProviderChain="true"/>
----
+
. Export this to get a deployable zip archive.
. Deploy to Runtime Manager and set the properties aws.accessKeyId and aws.secretKey through Runtime Manager > Settings > Properties.
. Finish deployment and test.
. Observe that access key and secret key are not mentioned in the connector config and the correct values are used from the values specified in the settings. More information about Default AWS Credentials Provider Chain can be found here at  http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html#using-the-default-credential-provider-chain[using the default provider credential chain].

=== To Build with Maven

If you are coding your application to build with Maven, include the `<artifactId>mule-module-s3</artifactId>` in your `pom.xml` file:

[source,xml,linenums]
----
<dependency>
    <groupId>org.mule.modules</groupId>
    <artifactId>mule-module-s3</artifactId>
    <version>4.2.0</version>
</dependency>
----

== Example: Store and Retrieve an Image

. Create a new Mule project in Anypoint Studio.

. Drag building blocks to the Canvas to create this configuration:
+
image:ams3_04.png[ams3_04]
+
. Begin the flow by sending a message to a bucket.
. Drag an HTTP connector into the canvas, then select it to open the properties editor console.
. Add a new HTTP connector, click the green plus sign next to Connector Configuration, and click OK to accept
the default settings.
. Drag the Amazon S3 connector onto the canvas, then select it to open the properties editor.
. Set the access and secret keys and test your connection.
. Set the operation to Create Bucket and set the bucket name to `#[payload]` or `${bucketName}` to pick the value using MEL expression. Set the Canned ACL to the `PUBLIC_READ` value.
. Add a *HTTP Connector* to request the MuleSoft logo from MuleSoft. Set the Path to `sites/all/themes/mulesoft_community/logo.png` and the Method to GET.
. Drag another Amazon S3 connector to create the requested MuleSoft logo in the selected Amazon S3 Bucket.
. Set the Operation to Create Object, the Bucket Name to the `${config.bucket}` value, and the key to mulesoft.png, and the Content Reference to the `#[payload]` value.
. Add another Amazon S3 connector to get the newly created MuleSoft logo image object from the bucket.
. Set the Operation to Get Object Content, the Bucket Name to the `${config.bucket}` value, and the key to mulesoft.png.
. Add an Amazon S3 connector to delete the bucket. Since delete bucket operation’s return type is void, the payload contains the object returned by the get image operation.

== Example: XML Listing

[source,xml, linenums]
----
<?xml version="1.0" encoding="UTF-8" ?>
<mule xmlns:s3="http://www.mulesoft.org/schema/mule/s3" 
xmlns:http="http://www.mulesoft.org/schema/mule/http" 
xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" 
xmlns="http://www.mulesoft.org/schema/mule/core" 
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
xmlns:spring="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation=" http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/tracking
http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/s3
http://www.mulesoft.org/schema/mule/s3/current/mule-s3.xsd" >

<http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" 
doc:name="HTTP Listener Configuration" />
<http:request-config name="HTTP_Request_Configuration" host="mulesoft.org" 
port="80" doc:name="HTTP Request Configuration" />
<s3:config name="Amazon_S3_Configuration" accessKey="${config.accessKey}" 
secretKey="${config.secretKey}" doc:name="Amazon S3: Configuration" />
  <flow name="s3-example-flow" >
    <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP" />
    <s3:create-bucket config-ref="Amazon_S3_Configuration" bucketName="${config.bucket}" 
    acl="PUBLIC_READ" doc:name="Create S3 Bucket" />
    <http:request config-ref="HTTP_Request_Configuration" 
    path="sites/all/themes/mulesoft_community/logo.png" method="GET" 
    doc:name="Get MuleSoft logo" />
    <s3:create-object config-ref="Amazon_S3_Configuration" 
    doc:name="Create logo object in S3 bucket" acl="PUBLIC_READ" 
    bucketName="${config.bucket}" key="mulesoft.png" />
    <s3:get-object-content config-ref="Amazon_S3_Configuration" 
    bucketName="${config.bucket}" key="mulesoft.png" doc:name="Get Image" />
    <s3:delete-bucket config-ref="Amazon_S3_Configuration" bucketName="${config.bucket}" 
    force="true" doc:name="Delete S3 Bucket" />
  </flow>
</mule>
----

== See Also

* Learn more about working with link:/mule-user-guide/v/3.8/anypoint-connectors[Anypoint Connectors].
* link:/release-notes/amazon-s3-connector-release-notes[Amazon S3 Connector Release Notes].
* link:/mule-user-guide/v/3.8/using-maven-with-mule[Using Maven with Mule].
* link:/mule-user-guide/v/3.8/mule-transformers[Mule Transformers].
