= Building an External Provider
:keywords: oauth,raml,ldap

To apply the link:/api-manager/external-oauth-2.0-token-validation-policy[OAuth 2.0 Access Token Enforcement Using External Provider policy], you first build and deploy a separate OAuth provider application that verifies the validity of OAuth 2.0 credentials. When you apply the OAuth 2.0 Access Token Enforcement Using External Provider policy, you specify the OAuth provider endpoint in `Access Token validation endpoint url`:

image::external-oauth-2.0-token-validation-policy-ba3c0.png[external-oauth-2.0-token-validation-policy-ba3c0,height=375,width=404]

== Prerequisites

Run the external OAuth provider application on one of the following installations:

* Mule 3.8.0 runtime or later
* API Gateway runtime 2.0 or earlier

These runtimes employ the link:/mule-user-guide/v/3.8/http-connector[new HTTP Connector] whereas earlier runtimes use the link:/mule-user-guide/v/3.8/deprecated-http-transport-reference[deprecated endpoint-based HTTP transport].

=== Template Applications

Download one of the following OAuth2 provider templates:

* link:https://anypoint.mulesoft.com/exchange/#!/api-gateway-external-oauth2-provider?orgId=1[External OAuth2.0 server for Anypoint Platform]
+
This template relies on simple validation of credentials and is intended for testing and demo purposes.
+
* link:https://anypoint.mulesoft.com/exchange/#!/external-AES-template-LDAP?orgId=1[External OAuth 2.0 server for Anypoint Platform with LDAP Validation]
+
This template uses LDAP validation and is better suited for a proper implementation in production.


=== Keystore

Download the link:_attachments/keystore.jks[keystore.jks] that is required for configuring the OAuth Provider.

== Customizing the OAuth 2.0 Provider App

To build the OAuth provider application:

. Download one of the link:/api-manager/building-an-external-oauth-2.0-provider-application#template-applications[template applications] from Anypoint Exchange. 
. Import the downloaded OAuth2 provider template .zip file into Anypoint Studio as an *Anypoint Studio Generated Deployable Archive (.zip)*, and make sure it is using Mule 3.8.0 or API Gateway 2.x Runtime.
. Specify the same client Id and client secret as the organization where the API is managed.
. Configure auto-discovery.
. Copy the downloaded `keystore.jks` file to `src/main/resources`.
. Set the following properties in `src/main/resources/mule.dev.properties`
+
*For single authentication:*
+
[source,code,linenums]
----
# Properties to use in a development environment
key.store.password=mule123
key.store.key.password=mule123
key.store.path=keystore.jks
admin.name=name
admin.password=password
validate.endpoint.path=validate
authorization.endpoint.path=authorize
access.token.endpoint.path=access_token
scopes=
supported.grant.types=AUTHORIZATION_CODE RESOURCE_OWNER_PASSWORD_CREDENTIALS CLIENT_CREDENTIALS IMPLICIT
----
+
*For LDAP authentication:*
+
[source,code,linenums]
----
# Properties to use in a development environment
key.store.password=mule123
key.store.key.password=mule123
key.store.path=keystore.jks
 
ldap.userDn=cn=Manager,dc=my-domain,dc=com
ldap.password=root
ldap.url=ldap://localhost:389/dc=my-domain,dc=com
ldap.search.filter.1=ou=people,dc=my-domain,dc=com
ldap.search.filter.2=(uid={0})
validate.endpoint.path=validate
authorization.endpoint.path=authorize
access.token.endpoint.path=access_token
scopes=
supported.grant.types=AUTHORIZATION_CODE RESOURCE_OWNER_PASSWORD_CREDENTIALS CLIENT_CREDENTIALS IMPLICIT
----
+
. There are three endpoint paths, which you need to use in future steps:
+
[source,code,linenums]
----
validate.endpoint.path=validate
authorization.endpoint.path=authorize
access.token.endpoint.path=access_token
----
+
. If you're deploying your OAuth 2 provider to the same server as your proxy, change the port where it's hosted, as the default one overlaps with your proxy. In `src/main/resources` for the file `common.properties` and change the `http.port` property to anything other than 8082, in this example we use 8083. +
. Open the project `config.xml` file.
. Go to the Global Elements tab, under the canvas
. Edit the OAuth Provider module: +
+
image:OAuthProviderModule.png[OAuthProviderModule]
+
. Remove the default `READ WRITE` from *Scopes*, so you can use API Console.  +
.. In "Configuration XML" leaving defaultScopes="" and scopes=""
.. In userValidation.xml: within validateTokenFlow, scopes="" 
.. In link:http://oauth2-providervalidate[oauth2-provider:validate] element.
. Deploy the provider to CloudHub or on-premises.


=== Implementing CORS

This feature is available only when using Mule 3.8 runtime or API Gateway runtime 2.x. Earlier versions of the API Gateway runtime don't support configuring the OAuth provider to implement CORS. To apply or edit a CORS policy, see link:/api-manager/cors-policy[Applying and Editing a CORS Policy].

You may find that you need to implement CORS on your OAuth Provider. The *preFlow* attribute on the OAuth configuration element makes it possible to reference a flow that is processed before anything else. Using this attribute, your OAuth Provider configuration can reference an additional flow that has implemented a CORS configuration, enabling CORS in both the authorize and the access token listeners.

[source, xml, linenums]
----
  <flow name="myCorsFlow">
      <cors:validate publicResource="true"/>
  </flow>

  <oauth2-provider:config
      name="external-oauth2-provider"
      preFlow-ref="myCorsFlow"
      providerName="Ping API"
      resourceOwnerSecurityProvider-ref="single-user-security-provider"
      clientSecurityProvider-ref="single-user-client-security-provider"
      clientStore-ref="single-user-client-store"
      tokenTtlSeconds="86400"
      enableRefreshToken="true"
      listenerConfig-ref="https.listener">
  </oauth2-provider:config>
----

In the above example, the "myCorsFlow" flow configures CORS to allow requests from any origin. This flow is referenced in the OAuth 2.0 Provider via the *preFlow-ref* attribute.

=== Exposing Additional Endpoints


Depending on the OAuth grant type you want to use, the OAuth provider application can expose the following endpoints:

* `/authorize`: configured as an attribute of the `oauth2-provider:config` element
* `/access_token`: configured as an attribute of the `oauth2-provider:config` element
* `/validate`: configured as the address of the HTTP Listener Connector in the flow

[width="100%",cols="50%,50%",options="header",]
|===
|Component |Explanation
|`oauth2-provider:config` |This component encapsulates most of the configurations required to implement OAuth, both for generating tokens or authorization codes, and for validating them. It implicitly exposes two endpoints for assigning authorization codes and tokens. It is then referenced by a matching element in the flow.
|`ss:authentication-manager` |
- Spring bean that defines an authentication manager and provider +
 +
- Validates user credentials

|`api-platform-gw:client-store` |- Store that retains OAuth client-specific information. If the client sends validation credentials in the body or the query of the request, the OAuth Web service provider simply validates the incoming credentials (client ID and client secret) against the content in the clientStore +
- Caches client ID and client secret of valid organization's client applications
|`api-platform-gw:client-security-provider` |Validates client application's credentials.
|`mule-ss:security-manager` |- For configuring link:/mule-user-guide/v/3.7/configuring-the-spring-security-manager[Spring Security Manager] +
- Authenticates resource owners (for example: when the user credentials are validated after the login page). The only situation where this provider is not required, is when the Grant Type is Client Credentials.
|===


== End-to-End Example Implementation

In this example of how to build the OAuth Provider application, you configure API Gateway runtime 2.x or later to use the same client Id and client Secret as the organization where the API is managed.

. Download link:https://www.mulesoft.com/ty/dl/api-gateway[API Gateway 2.0] version or later and configure the runtime.
+
.. Log into link:https://anypoint.mulesoft.com/[Anypoint platform] and get the link:/api-manager/browsing-and-accessing-apis#accessing-your-application-client-id-and-client-secret[client_ID and client_secret] of your organization or of one of its Business Groups.
+
.. Edit the `./config/wrapper.conf` file from the API Gateway software distribution to add these parameters:
+
[source,java,linenums]
----
wrapper.java.additional.7=-Danypoint.platform.client_id=<your org client ID>
wrapper.java.additional.8=-Danypoint.platform.client_secret=<your org client-secret>
----
+
The numbers in these parameters (`wrapper.java.additional.` _n_) must run sequentially in order starting with 1 on the top parameter in the file.
+
The following is an example of the wrapper.conf file with the client ID and client secret statements:
+
[source,xml,linenums]
----
#wrapper.java.additional.<n>=-Dmule.clusterNodeId=1
#wrapper.java.additional.<n>=-Dmule.clusterSize=2
#############################


#######################################################################################
# Anypoint Platform Settings
#######################################################################################
# The following option is mandatory and identifies your Mule instance against
# the Anypoint Platform.
#
# wrapper.java.additional.<n>=-Danypoint.platform.client_id=c2a5ce1b9e924743bd2e332ddc538def
# wrapper.java.additional.<n>=-Danypoint.platform.client_secret=e633886bf99546adAAD7B7FE9D4961E7
#
# For the client to use a proxy when communicating back to the Anypoint Platform, you
# need to configure the following properties
#
# wrapper.java.additional.<n>=-Danypoint.platform.proxy_host=XXXXXXXX
# wrapper.java.additional.<n>=-Danypoint.platform.proxy_port=XXXXXXXX
# wrapper.java.additional.<n>=-Danypoint.platform.proxy_username=XXXXXXXX
# wrapper.java.additional.<n>=-Danypoint.platform.proxy_password=XXXXXXXX
#
# On-Prem Configuration
#
# wrapper.java.additional.<n>=-Danypoint.platform.on_prem=false
----
+
.. Edit the `api-gateway` domain to support HTTPS. This domain is used by the proxies you deploy to the API Gateway, and allows for multiple proxies to share a single port. By default this domain only enables HTTP communications. To also enable HTTPS, edit provide HTTPS credentials.
+
Open the file *mule-domain-config.xml* in the folder `/domains/api-gateway` of your API Gateway directory and edit its contents. Uncomment the second link:http://httplistener-config[http:listener-config] element and then fill in the fields relative to the keystore. Use the link:_attachments/keystore.jks[provided keystore].
+
[source,xml,linenums]
----
<http:listener-config name="https-lc-0.0.0.0-8082" host="0.0.0.0" port="8082" protocol="HTTPS">
        <tls:context name="tls-context-config">
            <tls:key-store path="${mule.home}/conf/keystore.jks" password="mule123" keyPassword="mule123"/>
        </tls:context>
</http:listener-config>
----
+
. Deploy an application with an API - This is the API that should be protected by the OAuth policy.
. Start the API Gateway.
. Copy `./examples/apps/leagues-rest` (from the Gateway home) to the `/apps` folder within your gateway installation. +
+
Copy the entire `leagues-rest` directory from the software examples folder.
+
. Open the Leagues App by browsing to http://localhost:8080/api/teams resource.
+
image:LeaguesListing.png[LeaguesListing]
+
. Again in the browser, open the RAML console at http://localhost:8080/console/. From here you can make calls to the Leagues API using its simple UI.
+
image:LaLiga.png[LaLiga]
+
. Log in to link:https://anypoint.mulesoft.com/[Anypoint platform].
. Register a new API in your Anypoint platform account, through this platform you can add a proxy in front of the backend API. For this tutorial, make sure to use the name `External AES Tutorial` and version `1.0`.
+
You can use this link:_attachments/api-v1.raml[RAML file] as a reference:
+
[source,yaml,linenums]
----
#%RAML 0.8
title: External AES Tutorial
version: 1.0
baseUri: http://localhost:8080/api
/teams:
  displayName: Teams
  get:
    queryParameters:
      city:
        type: string
        required: false
        example: Barcelona
    responses:
      200:
        body:
          application/json:
            example: |
              [{
                "name": "Athletic Bilbao",
                "id": "ATH",
                "homeCity": "Bilbao",
                "stadium": "San Mames"
              },
              {
                "name": "Atletico Madrid",
                "id": "ATL",
                "homeCity": "Madrid",
                "stadium": "Vicente Calderon"
              }]
----
+
. Save the API, return to the *API administration* screen, and click the API name to view API Definition, Portal, and Status page. 
. Click *API Status* > *Configure endpoint* to create an HTTPS proxy. Fill in the required information as follows. Using HTTPS works because you configured HTTPS settings in your gateway on a previous step. For more information, see  link:/api-manager/https-api-proxy-example[HTTPS API Proxy Example]:
+
image:ext-oauth2-configure-endpoint.png[ext-oauth2-configure-endpoint]
+
. Click *Save*.
. Download the latest version of the proxy.
+
image:ext-oauth2-api-status.png[ext-oauth2-api-status]
+
. The proxy application should be working at `https://localhost:8082/leagues/teams`

=== Applying the External OAuth2 Policy to the API

. Add the RAML snippet to the API's RAML in Designer. The updated RAML should look like link:_attachments/api-v2.raml[this one].
. Select "OAuth 2.0" from a drop-down in the link:https://localhost:8082/leagues-console[application console].
. On the API version page of the API, on the *Policies* tab, apply AES external policy providing the validation URL (in this case  https://localhost:8083/validate ).  +
If you are going to use the API Console, do not specify scopes. Do apply the CORS policy.
+
. Open the `https://localhost:8082/console` and try the teams resource. A 403 status code returns because you did not provide OAuth credentials in your request.

== Testing the External OAuth2 Policy

In the above example, you verified that the policy correctly rejects requests that don't include credentials. Now, verify that a request with the right credentials does get through to the API.

. Obtain OAuth credentials: +
.. If your API still doesn't have a Portal, on the API Portal section of the API Version page, select *Create* *New Portal* out of the dropdown menu
.. Then click on *View* *Live Portal*  to enter the editor, and there click the *Live Portal* link to see it as users of your portal would see it.
.. Click the *Request API Access* button to register an application to access your API.
.. Register a new application to the API (for this tutorial, you can leave Redirect URI empty), then click  *Request API Access*
.. On the API Version page, see the *Application* tab in the lower section, you should see application you just registered listed there. Get the client ID and secret for that application.
.  Open `https://localhost:8082/console` 
. Through the API Console UI, try to send a request the teams resource. Fill in the fields as follows:
.. Security Scheme →  OAuth2
.. Authorization Grant → Implicit
.. Client ID → Use the one you obtained from the application you registered in the previous step:
+
image:ext-oauth2-client-id.png[ext-oauth2-client-id]
+
. Click *GET,* and you are prompted for the username and password that you configured in the OAuth 2.0 external provider application: For example, username: `name` password: `password` )
+
image:ext-oauth2-ping-api.png[ext-oauth2-ping-api]
+
.  *Login and Authorize*. A 200 status code with the response appears.
+
image:ext-oauth2-login-and-auth.png[ext-oauth2-login-and-auth]

== See Also

* link:http://forums.mulesoft.com[MuleSoft's Forums]
* link:https://www.mulesoft.com/support-and-services/mule-esb-support-license-subscription[MuleSoft Support]
