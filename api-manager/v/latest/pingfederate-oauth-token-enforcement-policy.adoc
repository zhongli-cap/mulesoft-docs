= PingFederate OAuth Token Enforcement Policy
:keywords: pingfederate, oauth, api, credentials

The PingFederate OAuth Token Enforcement policy connects to a PingFederate authorization server and enforces access according to its configuration. Anypoint platform supports the link:https://www.pingidentity.com/en/products/pingfederate.html[Ping Federate] identity provider (IdP) link:/access-management/external-identity#instructions-for-saml-configuration[configured for SAML 2.0]-compliant identity management.

== Prerequisites

This policy is available only if the following prerequisites are met:

* Your organization is PingFederate
* Your user is the organization's administrator, or has permissions to create or manage APIs

If the OAuth token is not valid, PingFederate returns a `403 FORBIDDEN` error.

== Policy Implementation

This diagram shows how the PingFederate OAuth Token Enforcement policy works with an existing PingFederate authorization server to protect access to an API.

image::pingfederate-oauth-token-enforcement-policy-f1330.png[pingfederate-oauth-token-enforcement-policy-f1330]

The user authorizes the application to access the API by authenticating with user credentials. Upon receiving a valid user authorization, PingFederate supplies the application with a valid token. The application sends the valid token in the API call. The PingFederate OAuth Token Enforcement policy checks that the token in the header or query parameter is valid and matches the correct scopes. The policy invokes your organization's PingFederate authorization server to validate the token and check scopes, and finally the API receives the call from the application.

== Configuration

You might need to specify the following configurations to use the PingFederate OAuth Token Enforcement policy:

* Enable or disable use of a proxy
* The scope of access PingFederate server grants to your APIs under this policy

=== Configuring Use of a Proxy

The `anypoint.platform.ping_federate_enable_proxy_settings' parameter enables or disables the PingFederate OAuth Token Enforcement policy to or from using the Mule Runtime or API Gateway Runtime proxy settings in the /wrapper.conf file. 

You configure this parameter in the wrapper configuration file in one of the following locations:

* Mule Runtime 3.8.x: `$MULE_HOME/conf/wrapper.conf`, as shown below.
* API Gateway Runtime 2.1.x and 2.2.x: `/conf/wrapper.conf` file from the API Gateway software distribution 

Set the parameter to true or false. For example:

`wrapper.java.additional.<n>=-Danypoint.platform.ping_federate_enable_proxy_settings=true`

By default, the parameter is false. Consequently, the following proxy settings in the /wrapper.conf file are ignored by default:

----
wrapper.java.additional.<n>=-Danypoint.platform.proxy_host=localhost
wrapper.java.additional.<n>=-Danypoint.platform.proxy_port=8080
----

=== Configuring Scope of Access

When you apply the PingFederate OAuth Token Enforcement Policy, you need to configure  `scopes`. You need to know the names of the scopes as defined in PingFederate. Scope names are case-sensitive.

Assuming you have deployed the API, to configure `scopes`:

. In API Manager, navigate to the link:/api-manager/tutorial-set-up-and-deploy-an-api-proxy#navigate-to-the-api-version-details-page[API version details page]page of your API.
. Click *Apply*.  
. In the Configure PingFederate OAuth Token Enforcement Policy dialog, enter a space-separated list of strings that indicate the scopes to which APIs must have access. This access needs to correspond to credentials defined for your APIs in PingFederate.

== Incorporating Authorization into an API

Incorporate authorization into an API using the PingFederate OAuth Token Enforcement policy as link:/api-manager/openam-oauth-token-enforcement-policy#incorporating-authorization-into-an-api[previously described].