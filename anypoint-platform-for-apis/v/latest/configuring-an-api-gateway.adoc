= Configuring an API Gateway
:keywords: api, cloudhub, gateway, auto-discovery

[NOTE]
Looking for a basic introduction to the API Gateway? See the link:/anypoint-platform-for-apis/api-gateway-101[API Gateway 101] for answers to some frequently asked questions. See also link:/anypoint-platform-for-apis/api-gateway-domain[API Gateway Domain].

The *API Gateway* points to the backend APIs and services that you define and abstracts them into a layer that the Anypoint Platform for APIs manages. Consumer applications invoke your services. APIs route to the endpoints that the gateway exposes to enforce runtime policies and collect and track analytics data. The API Gateway acts as a dedicated orchestration layer for all your backend APIs to separate orchestration from implementation concerns. The gateway leverages the governance capabilities of the Anypoint Platform for APIs, so that you can apply throttling, security, and other policies to your APIs.

image:APIgateway.png[APIgateway]

== Choosing a Gateway Type

Two types of API Gateway are available:

* On premises (at your site)
* In the cloud

Both types are specially configured versions of Mule runtimes and can communicate with the Anypoint Platform for APIs, including support for link:/anypoint-platform-for-apis/api-auto-discovery[API auto-discovery].

Use on-premises API Gateway if you want to install and manage the gateway behind your firewall. MuleSoft works with you to size the installation and provide a license for the API Gateway. Like all Mule runtimes, API Gateway for on premises requires link:http://www.oracle.com/technetwork/java/javase/downloads/index.html[JDK 7 or 8] from Oracle.

Use cloud API Gateway if you don't want to install and maintain any MuleSoft software for your gateway. The cloud API Gateway is powered by CloudHub, MuleSoft's integration platform as a service (iPaaS).

== Downloading API Gateway for On Premises

Download API Gateway from the MuleSoft link:http://www.mulesoft.com/ty/dl/api-gateway[API Gateway downloads] page.

== Limitations

API Gateway supports the following MuleSoft connectors only:

* HTTP/S
* Jetty
* File
* JDBC
* WS-Consumer connectors

The API Gateway does not support MuleSoft batch components.

For more information about the limitations, contact Support by filing a ticket in the Support portal, linked from the top navigation bar in the Anypoint Platform.

*Licensing Note*: To utilize unsupported connectors or batch components you must license Mule ESB Enterprise.   

== Security

Communication between the Anypoint Platform and the API Gateway is handled by the agent, which uses OAuth 2 for authentication. The Anypoint Platform for API's agent packaged with the gateway interacts with the Anypoint Platform for APIs via a client ID and client secret. The Organization Administrator uses these credentials.

Each sub-organization within the organization also has a separate client ID and client secret for dealing with its corresponding APIs. The sub-organization owner uses these credentials.

You need to configure the client ID and client secret in the gateway before the gateway can connect with your Anypoint Platform for APIs organization. Read more about link:/anypoint-platform-for-apis/anypoint-platform-for-apis-system-architecture[how the API Gateway works with the agent].

*Note*: For on premises, API Gateway uses outbound port 443 to communicate over HTTPS with Anypoint Platform. You can work with your system administrator to ensure API Gateway has access to this port.

[NOTE]
====
If you set up the Gateway with a client ID and client secret that belong to the master organization, these credentials work for all of the APIs in the organization, including APIs under a sub-organization.

If you set up the Gateway with a client ID and client secret that belong to a sub-organization, then the credentials only work for APIs within that sub-organization.
====

== Configuring Anypoint Studio for Integration with Your Anypoint Platform Organization

Before you configure your production gateway, you may want to configure Anypoint Studio to work with your Anypoint Platform organization for testing. First, download the API Gateway runtime from the Studio Update Site.

. Under the `Help` menu in *Anypoint Studio*, select `Install New Software`. 
. In the *Work with:* field in the Install wizard, enter http://studio.mulesoft.org/r4/api-gateway/
.  Check the box next to *API Gateway runtime*, then click *Next*.
.  Follow the remaining steps to accept the installation. +

If you use this runtime when working with APIkit projects and API proxies, you can test connectivity with the platform and test any governance that you have applied to the endpoints. +

Next, configure your client ID and client secret in Anypoint Studio:

. Obtain your Organization's client ID and client secret. To do this, in the Anypoint Platform click the gear icon, go to the *Organization* tab, and click the name of your organization or corresponding Business Group.
. Open Anypoint Studio.
. Click *Anypoint Studio* > *Preferences*, and click the arrow next to *Anypoint Studio* to expand the node.
. Click *Anypoint Platform for APIs*.
.  In the *Client ID* and *Client Secret* fields, paste the unique values for your organization or sub-organization. +
. Leave the Host, Port, and Path defaults as they are and click *OK*.  

Your instance of Anypoint Studio is now set up to communicate with the Anypoint Platform for APIs.

== Setting Up Your Gateway

[tabs]
------
[tab,title="On-Premises Gateway"]
....
=== On-Premises Gateway

==== Downloading Files

. Unless you have already done so, download the latest version of *http://www.mulesoft.com/mule-studio[Anypoint Studio]* . Anypoint Studio gives you access to link:/anypoint-platform-for-apis/building-your-api[APIkit], which you can use to build new APIs. You can also use it to modify or create proxy applications for your existing APIs.
. link:http://www.mulesoft.com/ty/dl/api-gateway[Download a standalone API Gateway runtime]. Use this API Gateway instance for your production deployments.

==== Configuring Your Production API Gateway for Integration with the Anypoint Platform

Before installing API Gateway, refer to the link:/mule-user-guide/v/3.7/hardware-and-software-requirements[Hardware and Software Requirements] and work with mailto:support@mulesoft.com[MuleSoft support] if you need assistance.

. Obtain your Organization's client ID and client secret from an Organization Administrator or the client ID and client secret of your Business Group from the Business Group's owner.
+
[NOTE]
To obtain these, log in to the Anypoint Platform as an administrator or Business Group owner, click the gear icon at the top-right and then select the Organization tab.

.  Open the  `wrapper.conf` file in your `<MULE_HOME>/conf` folder.
+
[TIP]
`<MULE_HOME>` is the value of the MULE_HOME variable employed by MuleSoft's *API Gateway*, usually the root directory of the installation, such as `/opt/Mule/api-gateway-1.3.0/`.
+
.  Paste the following code as a new item at the end of the list in your file: +
+

[source,java,linenums]
----
wrapper.java.additional.<n>=-Danypoint.platform.client_id=<PasteYourUniqueValueHere>  
wrapper.java.additional.<n>=-Danypoint.platform.client_secret=<PasteYourUniqueValueHere>
----

Replace the value of  `<n>`  with the next incremental values over the previous entries in the list, then replace `<PasteYourUniqueValueHere>`  with the client ID and client secrets for your organization/Business Group.  

[NOTE]
====
If you prefer, you can pass the token via the command line when starting the gateway instead of adding it to your `wrapper.conf` file.

Start your gateway from the command line by running the following command (wrapped for readability--combine into one line before using):

*Mac/Linux/Unix*:

[source,code,linenums]
----
MULE_HOME/bin/gateway -M-Danypoint.platform.client_id=PASTE_YOUR_VALUE_HERE
 -M-Danypoint.platform.client_secret=PASTE_YOUR_VALUE_HERE
----

*Windows*:

[source,code,linenums]
----
MULE_HOME\bin\gateway.bat -M-Danypoint.platform.client_id=PASTE_YOUR_VALUE_HERE
 -M-Danypoint.platform.client_secret=PASTE_YOUR_VALUE_HERE
----

The above commands start your gateway in the terminal foreground. To run the gateway in the terminal background, include the `start` parameter as the first parameter to the `mule` command. In this case, to stop the gateway, run `gateway stop` or `gateway.bat stop`.
====

==== Obtaining and Installing Your Enterprise License

If you are using a trial Anypoint Platform for APIs account, you can follow all the steps above without installing a license for trial purposes. The trial download of the API Gateway includes a 30-day trial license. However, for production deployments of the gateway, you need a license for your API Gateway instances. Contact your account representative or file a support ticket to obtain your license file.

Follow these steps to replace your trial license file with an Enterprise license for production use.

. If you haven't already done so, contact MuleSoft to acquire an *Enterprise license* in the form of a `license.lic` file.
. If you are installing your license on multiple platforms, back up your new `license.lic` file in another location before proceeding.
. Open the terminal or command line on your system.
. For Mac/Unix/Linux, from the `<MULE_HOME>/bin` directory. Run the following command:    
+
[source,code]
----
./gateway -installLicense <path>/license.lic
----
+
(Replace `<path>` with the full or relative path to your license file.)
+
For Windows, first copy the  `license.lic`  file into the  `<MULE_HOME>\bin` folder. Then  `cd` to that directory and run the following command:
+
[source,code]
----
gateway -installLicense license.lic
----
+
. The gateway removes the temporary trial license and replaces it with the Enterprise license. In the `<MULE_HOME>/conf` directory, the gateway saves a new file called `muleLicenseKey.lic`
. The gateway starts running automatically after you install the license.

....
[tab,title="Cloud Gateway"]
....
=== Cloud Gateway

First, unless you have already done so, download the latest version of  *link:http://www.mulesoft.com/mule-studio[Anypoint Studio]*. Anypoint Studio gives you access to link:/anypoint-platform-for-apis/building-your-api[APIkit], which you can use to build new APIs. You can also use it to modify or create proxy applications for your existing APIs.

Assuming you have created an API in Anypoint Studio and deployed it to the  Anypoint Platform Cloud, follow these steps to run the application on the API Gateway. 

. In your API Administration page, click the version of an API. For example, click *1.0.development.
+
image:config-gateway-version.png[config-gateway-version]
+
The API version details page appears.
+
. In API Status, click *Configure Endpoint*.
+
image:config-gateway-cfg-endpoint.png[config-gateway-cfg-endpoint]
+
The *Configure endpoint* dialog appears.
+
. Select *Basic endpoint*.
+
image:config-gateway-basic-endpoint.png[config-gateway-basic-endpoint]
+
. Click *Save* to save the configuration.
+
In the *API Status* section of the API version details pages, a new link labeled *View configuration details* appears. At the bottom of the page, links for setting up policies, SLA tiers, and permissions appears.
+
. Click *View configuration details* to confirm that your API is running on API Gateway.
+
image:config-gateway-status.png[config-gateway-status]
+
. Set up policies, SLA tiers, and permissions using the links at the bottom of the API version details page.
image:config-gateway-details-bottom.png[config-gateway-details-bottom]

=== Manual Deployment to CloudHub

==== Logging In to Your Anypoint Platform Account

* link:https://anypoint.mulesoft.com[Log in] to the Anypoint Platform. If you haven't already done so, create an account now.

==== Deploying Applications to CloudHub with Your Organization's Client ID and Client Secret

. Obtain your Organization's client ID and client secret from an Organization Administrator or the client ID and client secret of your sub-organization from the sub-organization's owner
+
[NOTE]
To obtain these, log in to the Anypoint Platform as an administrator or sub-organization owner, click the gear icon at the top-right and then select the Organization tab.

. When you deploy or update an already deployed application on CloudHub, include your client ID and client secret as environment variables. Open the *Advanced* section and define two Environment Variables with your Anypoint Platform client ID and client secret, which you can obtain from an Organization Administrator. (For help with the location of the Advanced section, see link:/cloudhub/deploying-a-cloudhub-application[Deploying a CloudHub Application].) In the *Name* field, enter `anypoint.platform.client_id`, and in the *Value* field, enter your organization's unique `client_id`. Then, define a second environment variable by clicking the plus icon for a new line. In this line's *Name* field, enter `anypoint.platform.client_secret`, and in the *Value* field, enter your organization's unique client secret.
. Make sure that when deploying your application, you pick the runtime *Gateway 1.3* (or a higher version of the Gateway runtime) in the the *Mule Version* field.
. Once your application successfully deploys, any endpoints within your application are tracked by the Anypoint Platform for APIs agent in CloudHub.

[WARNING]
====
*Summary*

For all endpoints that you register in Anypoint Platform for APIs that point to proxies running on CloudHub, specify your host and port names according to the CloudHub standards. For the HTTP or HTTPS connector, specify the host as *localhost* and the port `${http.port}` in your application. Need more detail? See the link:/cloudhub/developing-a-cloudhub-application[directions]. In Anypoint Platform for APIs, replace `localhost` and `${http.port}` with the domain that you select for deployment.

Thus, you must configure information both in Anypoint Platform for APIs and in the underlying applications in the API Gateway for the agent to track your application in CloudHub.

* In the Anypoint Platform for APIs, use the same domain to which you deployed the application on CloudHub, with any additional paths.
* In your proxy applications that you deploy to CloudHub, set your host to `0.0.0.0` and your port to `${http.port}`.
====

[WARNING]
If you plan to expose your API through SSL, then there are a couple of link:/cloudhub/building-an-https-service[additional steps] you need to take.
....
------

== Using the API Gateway

You can use the API Gateway to proxy your existing services with HTTP/HTTPS or Web Service Consumer connectors to the Anypoint Platform for APIs, wherever they are implemented. You can also include selected additional connectors, as specified in your subscription plan. Contact your account representative for details about allowed connectors. If you need to proxy other kinds of endpoints, such as JMS, WebSphere MQ, Anypoint Connectors, or any other endpoint protocols, please talk to mailto:sales@mulesoft.com[your sales representative] about upgrading your installation to a full Mule ESB or CloudHub account, so that you can take advantage of the full suite of endpoints and message processing capabilities of the Anypoint Platform.

Because the API Gateway acts as an orchestration layer for services and APIs implemented elsewhere, it's technology-agnostic. You can proxy non-Mule services or APIs of any kind, as long as they expose HTTP/HTTPS, or endpoints for a Web Service Consumer. You can also proxy APIs that you design and build with API Designer and APIkit to the API Gateway to separate the orchestration from the implementation of those APIs.

Refer to the link:/mule-user-guide/v/3.6[Mule User Guide] or the link:/cloudhub[CloudHub Documentation] for reference information about using your API Gateway, keeping in mind the previously described usage restrictions.

== See Also

* Once you have your API Gateway set up, learn how to link:/anypoint-platform-for-apis/proxying-your-api[create proxy applications] for your APIs and link:/anypoint-platform-for-apis/deploying-your-api-or-proxy[deploy them to your API Gateway].
* Need to configure an on-premises proxy? See link:/anypoint-platform-for-apis/configuring-proxy-access-to-the-anypoint-platform-for-apis[Configuring Proxy Access to the Anypoint Platform for APIs].
* See also link:/anypoint-platform-for-apis/api-gateway-domain[API Gateway Domain].
* link:http://forums.mulesoft.com[MuleSoft's Forums]
* link:https://www.mulesoft.com/support-and-services/mule-esb-support-license-subscription[MuleSoft Support]
* mailto:support@mulesoft.com[Contact MuleSoft]
